---
# Playbook to deploy to Kubernetes cluster
- hosts: localhost
  gather_facts: no
  vars:
    namespace: "online-exam"
    k8s_manifests_path: "{{ playbook_dir }}/../k8s"
    kube_context: "docker-desktop"

  tasks:
    - name: "Set Kubernetes context"
      shell: "kubectl config use-context {{ kube_context }}"
      register: context_result

    - name: "Print context info"
      debug:
        msg: "Kubernetes context set to: {{ context_result.stdout }}"

    - name: "Create namespace"
      shell: "kubectl create namespace {{ namespace }} --dry-run=client -o yaml | kubectl apply -f -"
      register: namespace_result

    - name: "Create backend secret"
      shell: "kubectl create secret generic backend-secrets --from-literal=JWT_SECRET='super_secret_key' -n {{ namespace }} --dry-run=client -o yaml | kubectl apply -f -"
      register: secret_result

    - name: "Apply backend deployment"
      shell: "kubectl apply -f {{ k8s_manifests_path }}/backend-deployment.yaml"
      register: backend_deploy

    - name: "Apply frontend deployment"
      shell: "kubectl apply -f {{ k8s_manifests_path }}/frontend-deployment.yaml"
      register: frontend_deploy

    - name: "Apply ingress (optional)"
      shell: "kubectl apply -f {{ k8s_manifests_path }}/ingress.yaml"
      register: ingress_deploy
      ignore_errors: yes

    - name: "Wait for backend pods to be ready"
      shell: "kubectl wait --for=condition=ready pod -l app=backend -n {{ namespace }} --timeout=300s"
      register: backend_wait

    - name: "Wait for frontend pods to be ready"
      shell: "kubectl wait --for=condition=ready pod -l app=frontend -n {{ namespace }} --timeout=300s"
      register: frontend_wait

    - name: "Get deployment status"
      shell: "kubectl -n {{ namespace }} get pods,svc,deployments"
      register: status_result

    - name: "Print deployment status"
      debug:
        msg: "{{ status_result.stdout }}"
